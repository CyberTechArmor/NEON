name: Docker Build & Smoke Test

on:
  push:
    paths:
      - 'docker/**'
      - 'apps/*/Dockerfile'
      - 'apps/api/**'
      - 'apps/web/**'
      - 'packages/**'
  pull_request:
    paths:
      - 'docker/**'
      - 'apps/*/Dockerfile'
      - 'apps/api/**'
      - 'apps/web/**'
      - 'packages/**'

jobs:
  docker-lint:
    name: Lint Dockerfiles
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Lint API Dockerfile
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: docker/Dockerfile.api
          failure-threshold: error

      - name: Lint Web Dockerfile
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: docker/Dockerfile.web
          failure-threshold: error

  docker-compose-validate:
    name: Validate Docker Compose
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate docker-compose.yml.example syntax
        run: |
          cd docker
          docker compose -f docker-compose.yml.example config > /dev/null
          echo "✓ docker-compose.yml.example is valid"

  docker-build-test:
    name: Build & Smoke Test
    runs-on: ubuntu-latest
    needs: [docker-lint, docker-compose-validate]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Copy example config to active config
        run: |
          cp docker/docker-compose.yml.example docker/docker-compose.yml

      - name: Build Docker images
        run: |
          cd docker
          docker compose build --no-cache

      - name: Start infrastructure services
        run: |
          cd docker
          docker compose up -d postgres redis

      - name: Wait for infrastructure
        run: |
          echo "Waiting for PostgreSQL..."
          timeout 60 bash -c 'until docker compose -f docker/docker-compose.yml exec -T postgres pg_isready -U neon; do sleep 2; done'
          echo "✓ PostgreSQL is ready"

          echo "Waiting for Redis..."
          timeout 30 bash -c 'until docker compose -f docker/docker-compose.yml exec -T redis redis-cli -a neon_redis_dev ping | grep -q PONG; do sleep 2; done'
          echo "✓ Redis is ready"

      - name: Start API service
        run: |
          cd docker
          docker compose up -d api

      - name: Wait for API healthcheck
        run: |
          echo "Waiting for API to be healthy (this may take a few minutes)..."
          timeout 180 bash -c '
            until curl -sf http://localhost:3001/health > /dev/null 2>&1; do
              echo "  API not ready yet, waiting..."
              sleep 5
            done
          '
          echo "✓ API is healthy"

      - name: Start Web service
        run: |
          cd docker
          docker compose up -d web

      - name: Wait for Web service
        run: |
          echo "Waiting for Web to be accessible..."
          timeout 60 bash -c '
            until curl -sf http://localhost:3000 > /dev/null 2>&1; do
              sleep 2
            done
          '
          echo "✓ Web is accessible"

      - name: Test API endpoints
        run: |
          echo "Testing API health endpoint..."
          curl -sf http://localhost:3001/health | jq .

          echo "Testing API status/init endpoint..."
          curl -sf http://localhost:3001/api/status/init | jq .

      - name: Verify healthcheck tools installed
        run: |
          echo "Verifying wget is available in API container..."
          docker compose -f docker/docker-compose.yml exec -T api which wget
          echo "✓ wget is installed"

          echo "Verifying curl is available in API container..."
          docker compose -f docker/docker-compose.yml exec -T api which curl
          echo "✓ curl is installed"

      - name: Show container status
        if: always()
        run: |
          cd docker
          docker compose ps -a

      - name: Show API logs on failure
        if: failure()
        run: |
          cd docker
          echo "=== API Logs ==="
          docker compose logs api --tail=100

      - name: Show Web logs on failure
        if: failure()
        run: |
          cd docker
          echo "=== Web Logs ==="
          docker compose logs web --tail=100

      - name: Cleanup
        if: always()
        run: |
          cd docker
          docker compose down -v

# NEON HAProxy Configuration
# Generated by NEON setup script
#
# Installation:
#   1. Copy this file to /etc/haproxy/haproxy.cfg
#   2. Generate SSL certificate with certbot or similar
#   3. Combine cert: cat fullchain.pem privkey.pem > /etc/haproxy/certs/neon.example.com.pem
#   4. Reload HAProxy: systemctl reload haproxy

global
    log /dev/log local0
    log /dev/log local1 notice
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin
    stats timeout 30s
    user haproxy
    group haproxy
    daemon

    # SSL settings
    ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
    ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets
    tune.ssl.default-dh-param 2048

defaults
    log global
    mode http
    option httplog
    option dontlognull
    option http-server-close
    option forwardfor except 127.0.0.0/8
    option redispatch
    retries 3
    timeout connect 5s
    timeout client 50s
    timeout server 50s
    timeout http-request 10s
    timeout http-keep-alive 10s
    timeout queue 60s
    timeout tunnel 1h

# Stats page
listen stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 10s
    stats admin if LOCALHOST

# HTTP to HTTPS redirect
frontend http_front
    bind *:80
    mode http

    # ACME challenge
    acl is_acme path_beg /.well-known/acme-challenge/
    use_backend acme_backend if is_acme

    # Redirect everything else to HTTPS
    redirect scheme https code 301 if !is_acme

# HTTPS frontend
frontend https_front
    bind *:443 ssl crt /etc/haproxy/certs/neon.example.com.pem alpn h2,http/1.1
    mode http

    # Security headers
    http-response set-header Strict-Transport-Security "max-age=31536000; includeSubDomains"
    http-response set-header X-Content-Type-Options nosniff
    http-response set-header X-Frame-Options DENY
    http-response set-header Referrer-Policy strict-origin-when-cross-origin

    # ACLs for routing
    acl is_api path_beg /api/
    acl is_websocket path_beg /socket.io/
    acl is_websocket_upgrade hdr(Upgrade) -i websocket

    # Backend selection
    use_backend neon_api if is_api
    use_backend neon_api if is_websocket
    default_backend neon_web

# LiveKit frontend (separate domain)
frontend livekit_https
    bind *:443 ssl crt /etc/haproxy/certs/livekit.example.com.pem alpn h2,http/1.1
    mode http
    acl is_livekit_domain hdr(host) -i livekit.example.com
    use_backend neon_livekit if is_livekit_domain

# Backends
backend neon_api
    mode http
    balance roundrobin
    option httpchk GET /api/health
    http-check expect status 200
    server api1 127.0.0.1:3001 check inter 5s

backend neon_web
    mode http
    balance roundrobin
    option httpchk GET /
    server web1 127.0.0.1:3000 check inter 5s

backend neon_livekit
    mode http
    balance roundrobin
    option httpchk GET /
    timeout tunnel 1h
    server livekit1 127.0.0.1:7880 check inter 5s

backend acme_backend
    mode http
    server acme 127.0.0.1:8080

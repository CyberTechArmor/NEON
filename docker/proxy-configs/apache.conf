# NEON Apache Configuration
# Generated by NEON setup script
#
# Installation:
#   1. Enable required modules:
#      a2enmod proxy proxy_http proxy_wstunnel ssl headers rewrite
#   2. Copy this file to /etc/apache2/sites-available/neon.conf
#   3. Enable site: a2ensite neon
#   4. Get SSL with certbot: certbot --apache -d neon.example.com -d livekit.example.com
#   5. Reload Apache: systemctl reload apache2

# HTTP -> HTTPS redirect
<VirtualHost *:80>
    ServerName neon.example.com
    ServerAlias livekit.example.com

    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

    # Let's Encrypt challenge
    Alias /.well-known/acme-challenge/ /var/www/certbot/.well-known/acme-challenge/
    <Directory "/var/www/certbot/.well-known/acme-challenge/">
        Options None
        AllowOverride None
        Require all granted
    </Directory>
</VirtualHost>

# Main NEON site
<VirtualHost *:443>
    ServerName neon.example.com

    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/neon.example.com/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/neon.example.com/privkey.pem

    # Modern SSL configuration
    SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
    SSLHonorCipherOrder off

    # Security headers
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options DENY
    Header always set Referrer-Policy strict-origin-when-cross-origin

    # Enable WebSocket proxying
    RewriteEngine On

    # WebSocket (Socket.io)
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteCond %{HTTP:Connection} upgrade [NC]
    RewriteRule ^/socket.io/(.*) ws://127.0.0.1:3001/socket.io/$1 [P,L]

    # API routes
    ProxyPass /api/ http://127.0.0.1:3001/api/
    ProxyPassReverse /api/ http://127.0.0.1:3001/api/

    # Socket.io polling fallback
    ProxyPass /socket.io/ http://127.0.0.1:3001/socket.io/
    ProxyPassReverse /socket.io/ http://127.0.0.1:3001/socket.io/

    # Web client (default)
    ProxyPass / http://127.0.0.1:3000/
    ProxyPassReverse / http://127.0.0.1:3000/

    # Proxy settings
    ProxyPreserveHost On
    RequestHeader set X-Forwarded-Proto "https"
    RequestHeader set X-Forwarded-Port "443"

    # Logging
    ErrorLog ${APACHE_LOG_DIR}/neon_error.log
    CustomLog ${APACHE_LOG_DIR}/neon_access.log combined
</VirtualHost>

# LiveKit site (separate domain)
<VirtualHost *:443>
    ServerName livekit.example.com

    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/livekit.example.com/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/livekit.example.com/privkey.pem

    SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
    SSLHonorCipherOrder off

    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"

    # WebSocket support
    RewriteEngine On
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteCond %{HTTP:Connection} upgrade [NC]
    RewriteRule ^/(.*) ws://127.0.0.1:7880/$1 [P,L]

    ProxyPass / http://127.0.0.1:7880/
    ProxyPassReverse / http://127.0.0.1:7880/

    ProxyPreserveHost On
    RequestHeader set X-Forwarded-Proto "https"

    ErrorLog ${APACHE_LOG_DIR}/livekit_error.log
    CustomLog ${APACHE_LOG_DIR}/livekit_access.log combined
</VirtualHost>
